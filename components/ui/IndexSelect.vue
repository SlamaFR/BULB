<script setup lang="ts">
const { mode } = defineProps<{
  mode: Mode | null
}>()
const emit = defineEmits<{
  updateColor: [color: string | null]
}>()
const index = defineModel<LineIndex | null>({ required: true })
const { getModeIndices, findIndexById } = useCustomLineIndices()

const availableDefaultLines = computed(() => getLinesByMode(mode))
const availableCustomLines = computed(() => getModeIndices(mode).map(it => ({
  value: {
    mode: it.mode,
    $customLineIndex: { id: it.id },
  },
  label: `Ligne ${it.prefix}${it.index}${it.suffix}`,
})))
const availableLines = computed(() => [
  {
    label: 'Indices officiels',
    items: availableDefaultLines.value,
  },
  {
    label: 'Indices personnalisÃ©s',
    items: availableCustomLines.value,
  },
])

watch(index, val => emit('updateColor', indexToChoice(val)?.color ?? null))

function isBuiltin(index: LineIndex | null): index is BuiltinLineIndex {
  if (index === null) return false
  return '$builtinLineIndex' in index
}
function isCustom(index: LineIndex | null): index is CustomLineIndex {
  if (index === null) return false
  return '$customLineIndex' in index
}

function indexToChoice(index: LineIndex | null): IndexChoice<LineIndex> | null {
  if (index === null) return null
  if (isBuiltin(index)) {
    return findLineByValue(index)
  }
  if (isCustom(index)) {
    const customIndex = findIndexById(index.$customLineIndex.id)
    if (customIndex === null) return null
    return {
      value: index,
      label: `Ligne ${customIndex.prefix}${customIndex.index}${customIndex.suffix}`,
      color: customIndex.color,
    }
  }
  return null
}
</script>

<template>
  <Select
    v-model="index"
    :options="availableLines"
    placeholder="Selectionner un indice"
    option-group-children="items"
    option-group-label="label"
    option-value="value"
    class="flex-auto"
  >
    <template #value="slotProps">
      <div v-if="slotProps.value" class="flex items-center gap-3">
        <LineIndex class="text-1.25em" :index="slotProps.value" />
        <span>{{ indexToChoice(slotProps.value)?.label }}</span>
      </div>
    </template>
    <template #option="slotProps">
      <div class="flex items-center gap-3">
        <LineIndex class="text-1.25em" :index="slotProps.option.value" />
        <span>{{ slotProps.option.label }}</span>
      </div>
    </template>
  </Select>
</template>
